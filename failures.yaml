- error: TailwindCSS依存関係エラー
  timestamp: 2023-10-01
  cause: Tailwind CSSの依存関係モジュールが見つからない
  solution: |
    1. package.jsonに正しい依存関係を追加：
       npm install -D tailwindcss postcss autoprefixer
    2. postcss.config.jsを正しく設定
  notes: Next.js 14.2.28ではTailwindCSSの設定方法が変更されている

- error: 重複ページパス
  timestamp: 2023-10-01
  cause: 同じURLに解決される複数のページファイルが存在
  solution: |
    1. 重複しているページを削除
       - src/app/plans/page.tsx
       - src/app/(protected)/dashboard/page.tsx（リダイレクト設定済み）
  notes: Next.jsのルートグループ機能を使用する場合、パスの重複に注意 

- error: 削除したはずのファイルがビルド時に参照される
  timestamp: 2023-10-01
  cause: GitHubのリポジトリとVercelのビルド環境の同期問題
  solution: |
    1. 該当ファイルを明示的に再削除する
       git rm -f src/app/plans/page.tsx
    2. コミットとプッシュを確認する
       git commit -m "plans重複ページを完全に削除"
       git push
    3. Vercelのキャッシュをクリアする（必要に応じて）
  notes: ファイル削除のコミットがVercelに正しく反映されていない場合がある 

- error: FirebaseモジュールパスおよびTailwindCSS問題
  timestamp: 2023-10-02
  cause: |
    1. Firebaseのインポートパスが壊れている（古いバージョン形式または不正なパス）
    2. TailwindCSSのパッケージが見つからない
  solution: |
    1. package.jsonを更新しFirebaseの最新バージョンをインストール
    2. すべてのFirebaseインポートを修正して正しいモジュラー形式を使用
    3. tailwindcssとpostcssパッケージを追加
  notes: Firebase v9以降はモジュラーAPIを使用。古いインポートパスは機能しない。 

- error: Firebase内部パス参照問題
  timestamp: 2023-10-02
  cause: |
    FirebaseのSDKが内部パス（./app/dist/index.esm.js, ./auth/dist/index.esm.js）を直接参照している
  solution: |
    1. @firebase/*の依存関係を更新
    2. package.jsonのFirebase関連パッケージを整理
    3. Next.jsのwebpack設定でFirebaseを適切に扱うよう修正
  notes: |
    Firebase v11ではパッケージ構造が大きく変更されており、内部パスへの直接アクセスは推奨されていない 

errors:
  - name: "ビルドエラー（Firebaseパス問題）"
    date: "2024-04-11"
    cause: "next.config.jsのエイリアス設定が古いFirebaseパスを強制的に使用していた"
    solution: "エイリアス設定を削除し、Firebaseが正しいパスを使えるようにした"
    details: "Firebase v9以降は新しいインポートパスを使うため、古いパスを強制するエイリアス設定が競合の原因だった"
    
  - name: "静的生成エラー（サーバーコンポーネント）"
    date: "2024-04-11"
    cause: "多くのページで「Component auth has not been registered yet」エラーが発生"
    solution: "ESLintとTypeScriptチェックを一時的に無効化し、デプロイを試行"
    details: "静的生成時にFirebase認証コンポーネントが初期化前にアクセスされている。本番環境ではサーバーサイドレンダリングで正常に動作する可能性あり"
    note: "完全な解決には認証初期化の順序を修正する必要があるが、一時的な回避策を適用"

  - name: "認証コンポーネント初期化エラー"
    date: "2024-04-11"
    cause: "静的生成時に「Component auth has not been registered yet」エラーが多発"
    solution: "認証モジュールをサーバーサイドレンダリングに完全に切り替える"
    details: "Next.jsの静的ビルド時に認証コンポーネントが初期化されない問題。APIルートと認証ページを静的生成から除外する必要あり" 

  - name: "Stripe URLエラー"
    date: "2024-04-11"
    cause: "「Invalid URL: undefined/dashboard?success=true. URLsは http または https で始まる必要がある」"
    solution: "環境変数NEXT_PUBLIC_URLが常に設定されるよう修正"
    details: "Vercel環境で環境変数が正しく読み込まれていないか、条件分岐が適切に機能していない" 

  - name: "exportPathMap互換性エラー"
    date: "2024-04-11"
    cause: "App Routerでは「exportPathMap」設定が使用できない"
    solution: "next.config.jsから「exportPathMap」を削除し、別の方法で認証ページを処理"
    details: "Next.jsのApp Routerでは「generateStaticParams()」を使用する必要がある" 

  - name: "パッケージ設定の競合"
    date: "2024-04-11"
    cause: "'transpilePackages'と'serverComponentsExternalPackages'の設定が競合"
    solution: "重複している'firebase', '@firebase/auth'パッケージをtranspilePackagesから削除"
    details: "同じパッケージを両方の設定に含めることはできない"
    
  - name: "静的生成エラー"
    date: "2024-04-11"
    cause: "認証・APIルートを静的生成で処理しようとしている"
    solution: "静的生成からSSRモードに切り替え、または認証関連ページを静的生成から除外"
    details: "Firebase認証コンポーネントの初期化前にアクセスされ、多数のエラーが発生している"
    
  - name: "Stripe URL未定義エラー"
    date: "2024-04-11"
    cause: "「Invalid URL: undefined/dashboard?success=true」エラー発生"
    solution: "環境変数NEXT_PUBLIC_URLの設定確認と適切なフォールバック処理の追加"
    details: "ビルド時に環境変数が正しく読み込まれていない" 

  - name: "Next.js設定値の無効なオプション"
    date: "2024-04-11"
    cause: "output: 'server'は無効なオプションが指定されている"
    solution: "Next.jsの有効なoutput値（'standalone'または'export'）に修正"
    details: "Next.js 14.2では'server'はoutputとして認識されないため設定エラーが発生"
    
  - name: "Firebaseコンポーネント初期化エラー"
    date: "2024-04-11"
    cause: "静的生成時のFirebase Auth初期化で「Component auth has not been registered yet」エラー"
    solution: "静的生成対象からFirebaseを使うページを除外するか、動的インポートに変更"
    details: "サーバーサイドでのFirebase Auth初期化順序が不適切" 

  - name: "Stripe URL処理の詳細問題"
    date: "2024-04-11"
    cause: "StripeセッションURLがhttp/httpsで始まらない（undefined/dashboard?success=true）"
    solution: "環境変数の読み込みタイミングとチェックポイントの追加"
    details: "ビルド時とランタイム時で環境変数の挙動が異なり、Stripe処理時に値が正しく取得できていない" 

  - name: "実験的設定オプションの無効化"
    date: "2024-04-11"
    cause: "next.config.jsで不明なexperimental設定が使用されている"
    solution: "runtime、serverComponentsなどの非サポートオプションを削除"
    details: "Next.js 14.2.28では一部の実験的機能がサポートされていない"
    note: "実験的設定は頻繁に変更されるため、公式ドキュメントを確認する必要あり"

  - name: "動的APIルートのレンダリング失敗"
    date: "2024-04-11"
    cause: "/api/auth/verifyなど動的ルートがstatic exportモードで使用されている"
    solution: "standalonモードを使用し、動的ルートの処理方法を修正"
    details: "動的API（request.headersを使用）は静的生成と互換性がない"
    note: "Vercelのサーバーレス関数として動作させる必要がある"

  - name: "Stripe決済処理エラー"
    date: "2024-04-11"
    cause: "price IDが設定されていない（line_items[0]にpriceかprice_dataが必要）"
    solution: "StripeダッシュボードでpriceIDを設定し、環境変数で渡す"
    details: "本番環境では.env.localの値ではなく、Vercelの環境変数が使用される"
    note: "本番環境では.env.localの値ではなく、Vercelの環境変数が使用される"

  - name: "サーバーコンポーネントエラー"
    date: "2024-04-11"
    cause: "Unsupported Server Component type: {...}が多数発生"
    solution: "クライアントコンポーネントとサーバーコンポーネントの区別を明確にする"
    details: "コンポーネントの使用方法がNext.jsの期待する形式と異なる"
    note: "use clientディレクティブの適切な配置を確認"

- error: Next.js設定エラー
  timestamp: 2025-04-11
  cause: next.config.jsで無効なオプション「runtime」「serverComponents」が使用されている
  solution: |
    次のように不要なオプションを削除する:
    ```javascript
    /** @type {import('next').NextConfig} */
    const nextConfig = {
      reactStrictMode: true,
      swcMinify: true,
      
      experimental: {
        // 不要なオプションを削除
        optimizeCss: false,
        optimizePackageImports: ['react', 'react-dom', 'next'],
        serverComponentsExternalPackages: ['firebase', '@firebase/auth'],
      },
      
      // ESLintとTypeScriptチェックはそのまま
      eslint: {
        ignoreDuringBuilds: true,
      },
      typescript: {
        ignoreBuildErrors: true,
      },
      
      output: 'standalone',
    };
    ```
  notes: "Next.js 14.2.28では一部の実験的オプションが変更または削除されています"

- error: Stripe決済処理エラー
  timestamp: 2025-04-11
  cause: ライン項目にpriceまたはprice_dataが設定されていない
  solution: |
    src/app/api/stripe/annual-session/route.tsを修正：
    ```typescript
    // 正しい環境変数名を確認
    const priceId = process.env.STRIPE_PRICE_ID_ANNUAL;
    
    // 価格IDのチェックを追加
    if (!priceId) {
      console.error('Stripe API: 価格IDが設定されていません');
      return NextResponse.json(
        { error: '価格IDが設定されていません' },
        { status: 400 }
      );
    }
    
    // line_itemsにpriceを明示的に指定
    const session = await stripe.checkout.sessions.create({
      payment_method_types: ['card'],
      line_items: [
        {
          price: priceId, // ここが重要
          quantity: 1,
        },
      ],
      mode: 'subscription',
      success_url: `${process.env.NEXT_PUBLIC_API_URL}/dashboard?success=true`,
      cancel_url: `${process.env.NEXT_PUBLIC_API_URL}/plans?canceled=true`,
    });
    ```
  notes: "本番環境ではVercelの環境変数設定でSTRIPE_PRICE_ID_ANNUALを設定する必要があります"

- error: サーバーコンポーネントエラー
  timestamp: 2025-04-11
  cause: クライアントコンポーネントとサーバーコンポーネントの混在
  solution: |
    1. 'use client' ディレクティブを適切に配置
    2. AuthContextなどのクライアントコンポーネントは専用のプロバイダーで分離
    3. ClientLayoutコンポーネントを実装：
    ```typescript
    // src/components/ClientLayout.tsx
    'use client';
    
    import { ReactNode } from 'react';
    import { AuthProvider } from '@/context/AuthContext';
    
    export default function ClientLayout({ children }: { children: ReactNode }) {
      return <AuthProvider>{children}</AuthProvider>;
    }
    ```
  notes: "Next.js 14では、サーバーコンポーネントとクライアントコンポーネントの区別がより厳格になっています"

- error: 動的APIルートエラー
  timestamp: 2025-04-11
  cause: 静的生成時にrequest.headersを使用している
  solution: |
    1. APIルートを静的に生成しないようにする：
    ```typescript
    // 各APIルートファイルの先頭に追加
    export const dynamic = 'force-dynamic';
    ```
    
    2. または、ミドルウェアでAPIルートへのリクエストを処理：
    ```typescript
    // middleware.ts
    export const config = {
      matcher: ['/api/:path*']
    };
    ```
  notes: "APIルート（特に認証が必要なもの）は通常force-dynamicに設定すべきです" 

- error: ルートパス衝突エラー
  timestamp: 2024-04-11
  cause: 同じパスに解決される2つの並行ページが存在している
  solution: |
    以下のパスが衝突しています：
    - src/app/(dashboard)/dashboard/page.tsx
    - src/app/(main)/dashboard/page.tsx
    
    どちらかを削除するか、パスを変更する必要があります。
  details: "Next.jsのルートグループ（括弧で囲まれた部分）はURLパスには影響しないため" 

- error: サーバーコンポーネントの静的レンダリング失敗
  timestamp: 2024-04-11
  cause: クライアントコンポーネントとサーバーコンポーネントの混在による静的生成エラー
  solution: |
    静的生成からSSRモードに切り替える：
    1. next.config.jsの設定変更
    2. すべてのAPIルートに force-dynamic 設定を追加
    3. Authコンポーネントの適切なクライアント/サーバー分離
  details: "多数の 'Unsupported Server Component type: {...}' エラーが発生" 

- error: Next.js実験的設定エラー
  timestamp: 2024-04-11
  cause: "experimental.serverActions: true の設定が無効になっている"
  solution: |
    実験的設定を正しく更新：
    1. serverActionsは既にデフォルトで有効なので削除
    2. 全ページを強制的に動的レンダリングに変更
  details: "Expected object, received boolean at 'experimental.serverActions'"

- error: 静的生成とクライアントコンポーネントの互換性エラー
  timestamp: 2024-04-11
  cause: "サーバーコンポーネントとクライアントコンポーネントが混在した状態で静的生成を試みている"
  solution: |
    静的生成を完全に諦め、SSRモードに切り替える：
    1. next.config.jsでoutputを'export'から'server'に変更
    2. 各ページファイルに`export const dynamic = 'force-dynamic'`を追加
    3. vercel.jsonファイルでSSRモードを明示的に設定
  details: "Element type is invalid: expected a string but got: undefined"

- error: Next.js出力モード設定エラー
  timestamp: 2024-04-11
  cause: "出力モード'server'が無効: 'Expected standalone | export, received server at output'"
  solution: |
    正しいNext.js設定に修正:
    1. outputを'server'から'standalone'に変更
    2. 全ページで動的レンダリングを強制
    3. コンポーネントのクライアント/サーバー分離を徹底
  details: "現在のNext.jsバージョンでは'server'出力モードがサポートされていない"

- error: 'use client' ディレクティブの配置エラー
  timestamp: 2024-04-11
  cause: "'use client' ディレクティブがファイルの先頭ではなく、他の式の後に配置されている"
  solution: |
    クライアントコンポーネントでは、'use client'を必ずファイルの先頭（コメントを除く）に配置する：
    ```typescript
    'use client';
    
    export const dynamic = 'force-dynamic';
    export const runtime = 'nodejs';
    ```
  details: "Next.jsのクライアントコンポーネントでは、'use client'ディレクティブが最初に配置される必要がある"